<!DOCTYPE html>
<html lang="en" spellcheck="false">
    <head>
        <!-- start of Google tag (gtag.js) -->
        <!-- tagmanager.google.com -->
        <!-- analytics.google.com/analytics/web -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-LECMLYN21B"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-LECMLYN21B');
        </script>
        <!-- end of Google tag (gtag.js) -->

        <!-- start of Google Search Console Ownership verification -->
        <!-- search.google.com * search-console/ownership -->
        <meta name="google-site-verification" content="UqB5vtnZNIl-hvyiqwM0PDgX772rcbWWjt0g9onB_BQ" />
        <meta name="robots" content="index, follow" />
        <meta name="googlebot" content="notranslate" />
        <meta name="google" content="nopagereadaloud" />
        <!-- end of Google Search Console Ownership verification -->

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="Willy Horizont" />
        <link rel="icon" type="image/x-icon" href="../../favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png" />
        <link rel="icon" type="image/png" sizes="192x192" href="../../android-chrome-192x192.png" />
        <link rel="icon" type="image/png" sizes="512x512" href="../../android-chrome-512x512.png" />
        <link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png" />
        <link rel="stylesheet" href="../../style.css" />
        <script src="../../local-database.js"></script>
        <script src="../../utils.js"></script>
        <script src="../../utils-web.js"></script>
        <script src="../../component/component-user-browser-checker.js"></script>

        <meta name="description" content="Expense Tracker by Willy Horizont" />
        <meta name="keywords" content="Expense Tracker by Willy Horizont" />
        <title>Expense Tracker | Portfolio | Willy Horizont</title>

        <!-- start of Google AdSense -->
        <!-- adsense.google.com/adsense -->
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5944204031363480" crossorigin="anonymous"></script>
        <!-- end of Google AdSense -->

        <link rel="stylesheet" href="../../component/component-chip-input.css" />
        <link rel="stylesheet" href="../../component/component-link.css" />

        <style>
            .price-input {
                border: 1px solid var(--light-border-color); padding: 20px 8px; outline: none; max-width: 120px;
                background-color: var(--light-background-color); color: var(--light-text-color);
            }

            html[data-theme="dark"] {
                .price-input {
                    background-color: var(--dark-background-color); color: var(--dark-text-color);
                }
            }
        </style>
    </head>
    <body>
        <header>
        </header>
        <main>
            <div style="padding: 8px;">
                <h1 style="text-align: center;">Expense Tracker</h1>
                <div id="expense-tracker-container" style="padding: 4px; width: 100%; display: flex; flex-direction: column; row-gap: 16px;"></div>
                <div style="padding: 4px; width: 100%; display: flex; flex-direction: column;">
                    <button onclick="createNewExpense()" style="padding: 0.2em 0.4em; width: 100%; background-color: var(--accent-color-3); color: var(--dark-text-color);">Add Expense (+)</button>
                    <h2>Total Expense: <span id="total-expense-container">0</span></h2>
                </div>
                <div id="placeholder-import-export"></div>
                <div id="placeholder-link"></div>
            </div>
        </main>
        <footer>
            <p>Made with ❤️ by Willy Horizont</p>
        </footer>
        <script src="../../component/component-navbar.js"></script>
        <script src="../../component/component-chip-input.js"></script>
        <script src="../../component/component-import-export.js"></script>
        <script src="../../component/component-link.js"></script>

        <script>
            const localDatabase = new LocalDatabase("expense-tracker");
            const chipInputPlaceholder = ("item a 2, item b 1, item c 4, ...");
            const collectionOrStoreKey = "expense-data";

            const componentImportExport = new ComponentImportExport({
                collectionOrStoreKey,
                rerenderMainContent,
                getDataFromMainContent: () => {
                    const dataFromImportExportTextAreaContent = (Array.from(document.getElementById("expense-tracker-container").children).reduce(((dataFromImportExportTextAreaContentCurrentResult, htmlElementExpense) => {
                        const newExpenseContainerContent = ({
                            "uuid": (htmlElementExpense.getAttribute("data-uuid") || ""),
                            "price": (htmlElementExpense.getAttribute("data-price") || ""),
                            "items": (JSON.parse(htmlElementExpense.children[1].getAttribute("data-items")) || []),
                        });
                        if (((newExpenseContainerContent?.price === "") && (Utils.checkIsArray(newExpenseContainerContent?.items) && (newExpenseContainerContent?.items?.length === 0))) === false) dataFromImportExportTextAreaContentCurrentResult.push(newExpenseContainerContent);
                        return dataFromImportExportTextAreaContentCurrentResult;
                    }), []));
                    return ((dataFromImportExportTextAreaContent.length === 0) ? null : dataFromImportExportTextAreaContent);
                },
            });

            const componentChipInput = new ComponentChipInput({ chipInputPlaceholder, collectionOrStoreKey, localDatabase, syncLocalStorageDataImportExportTextAreaContentWithMainContent: componentImportExport.syncLocalStorageDataImportExportTextAreaContentWithMainContent });

            function createHtmlElementExpenseContainer(arrayOfEntryAttribute) {
                const htmlElementExpenseContainer = UtilsWeb.htmlTemplateStringToHtmlElement(/*html*/`
                    <div data-id="expense-container" style="width: 100%; column-gap: 8px; padding: 8px; display: flex; flex-direction: row; border: 1px solid var(--light-border-color);">
                    </div>`
                );
                htmlElementExpenseContainer.setAttributes(arrayOfEntryAttribute);
                return htmlElementExpenseContainer;
            }

            function createHtmlElementPriceInputContainer({ arrayOfEntryProperty, arrayOfEntryAttribute }) {
                const htmlElementPriceInputContainer = UtilsWeb.htmlTemplateStringToHtmlElement(/*html*/`
                    <div data-id="price-input-container" style="display: flex; flex-direction: column; justify-content: flex-start; align-items: center;">
                        <input data-id="price-input" class="price-input" name="price-input" placeholder="1_234_500" type="text" />
                    </div>`
                );
                const htmlElementPriceInput = htmlElementPriceInputContainer.querySelector('[data-id="price-input"]');
                htmlElementPriceInput.setPropertyValues(arrayOfEntryProperty);
                htmlElementPriceInput.setAttributes(arrayOfEntryAttribute);
                htmlElementPriceInput.setEventStuffs([
                    ({ handlerRefName: "refElementHandlerChange", eventType: "change", elementHandler: handleElementChangePriceInput }),
                    ({ handlerRefName: "refEventHandlerKeydown", eventType: "keydown", eventHandler: handleEventKeyDownPriceInput }),
                    ({ handlerRefName: "refElementHandlerInput", eventType: "input", elementHandler: handleElementInputPriceInput }),
                    ({ handlerRefName: "refElementHandlerBlur", eventType: "blur", elementHandler: handleElementBlurPriceInput }),
                ]);
                return htmlElementPriceInputContainer;
            }

            function createHtmlElementExpenseRemoveButtonContainer() {
                const htmlElementExpenseRemoveButtonContainer = UtilsWeb.htmlTemplateStringToHtmlElement(/*html*/`
                    <div data-id="expense-remove-button-container" style="display: flex; flex-direction: column; justify-content: flex-start; align-items: center;">
                        <button data-id="expense-remove-button" style="background-color: var(--accent-color-4); color: white; border: none; padding: 0.2em 0.4em; cursor: pointer; width: 1.6em; aspect-ratio: 1 / 1;">x</button>
                    </div>`
                );
                const htmlElementExpenseRemoveButton = htmlElementExpenseRemoveButtonContainer.querySelector('[data-id="expense-remove-button"]');
                htmlElementExpenseRemoveButton.setEventStuffs([
                    ({ handlerRefName: "refElementHandlerClick", eventType: "click", elementHandler: handleElementClickExpenseRemoveButton })
                ]);
                htmlElementExpenseRemoveButtonContainer.appendChild(htmlElementExpenseRemoveButton);
                return htmlElementExpenseRemoveButtonContainer;
            }

            async function createHtmlElementExpense({ uuid = crypto.randomUUID(), price = "", items = [] } = {}) {
                const htmlElementExpenseContainer = createHtmlElementExpenseContainer([["data-uuid", uuid], ["data-price", price]]);
                htmlElementExpenseContainer.appendChild(createHtmlElementPriceInputContainer({ arrayOfEntryProperty: [["value", price]], arrayOfEntryAttribute: [["data-price", price]] }));
                const htmlElementChipInputContainer = await componentChipInput.createHtmlElementChipInputContainer(items);
                htmlElementExpenseContainer.appendChild(htmlElementChipInputContainer);
                htmlElementExpenseContainer.appendChild(createHtmlElementExpenseRemoveButtonContainer());
                return htmlElementExpenseContainer;
            }

            function updateTotalExpenses() {
                const htmlElementTotalExpenseContainer = document.getElementById("total-expense-container");
                const totalExpensesInNumeric = (Array.from(document.getElementById("expense-tracker-container").children).reduce(((totalExpensesInNumericCurrentResult, htmlElementExpense) => {
                    const priceInNumeric = (parseFloat(htmlElementExpense.getAttribute("data-price").replace((/_/g), "") || "0"));
                    return (totalExpensesInNumericCurrentResult + priceInNumeric);
                }), 0));
                htmlElementTotalExpenseContainer.textContent = totalExpensesInNumeric.toString().replace(Utils.regexPattern["three_digit_grouping"], "_");
            }

            async function createNewExpense() {
                const htmlElementExpenseNew = await createHtmlElementExpense();
                const htmlElementExpenseTrackerContainer = document.getElementById("expense-tracker-container");
                htmlElementExpenseTrackerContainer.appendChild(htmlElementExpenseNew);
                const htmlElementChipInputNew = htmlElementExpenseNew.querySelector('[data-id="chip-input"]');
                htmlElementChipInputNew.placeholder = chipInputPlaceholder;
                const htmlElementPriceInputNew = htmlElementExpenseNew.querySelector('[data-id="price-input"]');
                if (htmlElementPriceInputNew) htmlElementPriceInputNew.focus();
            }

            function handleElementInputPriceInput(htmlElementPriceInput) {
                return ((event) => {
                    if ((/^[0-9_]+$/).test(htmlElementPriceInput.value) === true) return;
                    htmlElementPriceInput.value = htmlElementPriceInput.value.replace((/[^0-9_]/g), "");
                });
            }

            function handleElementChangePriceInput(htmlElementPriceInput) {
                return (async (event) => {
                    const htmlElementExpenseContainer = htmlElementPriceInput.parentElement.parentElement;
                    htmlElementExpenseContainer.setAttribute("data-price", event.target.value.replace((/_/g), "").replace(Utils.regexPattern["three_digit_grouping"], "_"));
                    updateTotalExpenses();
                    await componentImportExport.syncLocalStorageDataImportExportTextAreaContentWithMainContent();
                })
            }

            async function handleEventKeyDownPriceInput (event) {
                if ((event.key === "Enter") || (event.keyCode === 13)) {
                    if (event.target.value.trim() === "") {
                        event.preventDefault();
                        return;
                    }
                    const htmlElementChipInputContainer = event.target.parentElement.parentElement.querySelector('[data-id="chip-input-container"]');
                    const datasetItems = JSON.parse(htmlElementChipInputContainer.getAttribute("data-items"));
                    if ((Utils.checkIsArray(datasetItems) === true) && (datasetItems.length === 0)) {
                        const htmlElementChipInput = htmlElementChipInputContainer.querySelector('[data-id="chip-input"]');
                        htmlElementChipInput.setAttribute("placeholder", chipInputPlaceholder);
                        htmlElementChipInput.focus();
                    }
                    event.preventDefault();
                    event.target.blur();
                    return;
                }
            }

            function handleElementBlurPriceInput(htmlElementPriceInput) {
                return (async (event) => {
                    let htmlElementPriceInputNewValue = htmlElementPriceInput.value.replace((/[^0-9_]/g), "");
                    htmlElementPriceInputNewValue = ((!htmlElementPriceInputNewValue) ? (htmlElementPriceInput.getAttribute("data-price").replace((/_/g), "") || "") : htmlElementPriceInputNewValue);
                    htmlElementPriceInput.value = htmlElementPriceInputNewValue.replace((/_/g), "").replace(Utils.regexPattern["three_digit_grouping"], "_");
                    const htmlElementExpenseContainer = htmlElementPriceInput.parentElement.parentElement;
                    htmlElementExpenseContainer.setAttribute("data-price", event.target.value.replace((/_/g), "").replace(Utils.regexPattern["three_digit_grouping"], "_"));
                    updateTotalExpenses();
                    await componentImportExport.syncLocalStorageDataImportExportTextAreaContentWithMainContent();
                })
            }

            function handleElementClickExpenseRemoveButton(htmlElementExpenseRemoveButton) {
                return (async (event) => {
                    const htmlElementExpenseContainer = htmlElementExpenseRemoveButton.parentElement.parentElement;
                    htmlElementExpenseContainer.querySelectorAll('[data-id="price-input"]').forEach((htmlElementPriceInput) => {
                        htmlElementPriceInput.removeEventListener("change", htmlElementPriceInput.refElementHandlerChange);
                        htmlElementPriceInput.removeEventListener("input", htmlElementPriceInput.refElementHandlerInput);
                        htmlElementPriceInput.removeEventListener("blur", htmlElementPriceInput.refElementHandlerBlur);
                    });
                    htmlElementExpenseContainer.querySelectorAll('[data-id="chip-input-container"]').forEach((htmlElementChipInputContainer) => {
                        htmlElementChipInputContainer.removeEventListener("click", htmlElementChipInputContainer.refElementHandlerClick);
                    });
                    htmlElementExpenseContainer.querySelectorAll('[data-id="chip-remove-button"]').forEach((htmlElementChipRemoveButton) => {
                        htmlElementChipRemoveButton.removeEventListener("click", htmlElementChipRemoveButton.refElementHandlerClick);
                    });
                    htmlElementExpenseContainer.querySelectorAll('[data-id="chip-input"]').forEach((htmlElementChipInput) => {
                        htmlElementChipInput.removeEventListener("keydown", htmlElementChipInput.refEventHandlerKeyDown);
                        htmlElementChipInput.removeEventListener("blur", htmlElementChipInput.refEventHandlerBlur);
                    });
                    htmlElementExpenseContainer.querySelectorAll('[data-id="expense-remove-button"]').forEach((htmlElementExpenseRemoveButton) => {
                        htmlElementExpenseRemoveButton.removeEventListener("click", htmlElementExpenseRemoveButton.refElementHandlerClick);
                    });
                    htmlElementExpenseContainer.remove();
                    updateTotalExpenses();
                    await componentImportExport.syncLocalStorageDataImportExportTextAreaContentWithMainContent();
                })
            }

            async function rerenderMainContent (dataFromImportExportTextAreaContent) {
                const htmlElementExpenseTrackerContainer = document.getElementById("expense-tracker-container");
                htmlElementExpenseTrackerContainer.innerHTML = "";

                for (const { uuid, price, items } of dataFromImportExportTextAreaContent) {
                    const htmlElementExpense = await createHtmlElementExpense({ uuid, price, items });
                    htmlElementExpenseTrackerContainer.appendChild(htmlElementExpense);
                }

                updateTotalExpenses();
            }

            const demoData = ([{
                "uuid": crypto.randomUUID(),
                "price": "158_200",
                "items": ["Milo 1", "Nescafe 3", "Ovaltine 2", "Cheetos 3", "Chitato 2"],
            }]);

            const runDemo = async () => {
                await localDatabase.setItem(collectionOrStoreKey, demoData);
                componentImportExport.updateImportExportTextAreaValue(demoData);
                await rerenderMainContent(demoData);
                document.getElementById("placeholder-error").innerHTML = "";
            };

            (async () => {
                const dataFromLocalStorage = await localDatabase.getItem(collectionOrStoreKey);
                if (dataFromLocalStorage === null) {
                    await runDemo();
                    return;
                }
                await componentImportExport.syncImportExportTextAreaContentMainContentWithLocalStorageData();
                document.getElementById("placeholder-error").innerHTML = "";
            })();
        </script>
    </body>
</html>
